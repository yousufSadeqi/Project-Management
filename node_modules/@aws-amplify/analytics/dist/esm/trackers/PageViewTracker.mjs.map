{"version":3,"file":"PageViewTracker.mjs","sources":["../../../src/trackers/PageViewTracker.ts"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { ConsoleLogger } from '@aws-amplify/core';\nimport { isBrowser } from '@aws-amplify/core/internals/utils';\nconst logger = new ConsoleLogger('PageViewTracker');\nconst DEFAULT_EVENT_NAME = 'pageView';\nconst DEFAULT_APP_TYPE = 'singlePage';\nconst DEFAULT_URL_PROVIDER = () => {\n    return window.location.origin + window.location.pathname;\n};\nconst PREV_URL_STORAGE_KEY = 'aws-amplify-analytics-prevUrl';\nexport class PageViewTracker {\n    constructor(eventRecorder, options) {\n        this.options = {};\n        this.trackerActive = true;\n        this.eventRecorder = eventRecorder;\n        this.spaTrackingActive = false;\n        this.handleLocationChange = this.handleLocationChange.bind(this);\n        this.configure(eventRecorder, options);\n    }\n    configure(eventRecorder, options) {\n        this.eventRecorder = eventRecorder;\n        // Clean up any existing listeners\n        this.cleanup();\n        // Apply defaults\n        this.options = {\n            appType: options?.appType ?? DEFAULT_APP_TYPE,\n            attributes: options?.attributes ?? undefined,\n            eventName: this.options?.eventName ?? DEFAULT_EVENT_NAME,\n            urlProvider: this.options?.urlProvider ?? DEFAULT_URL_PROVIDER,\n        };\n        // Configure SPA or MPA page view tracking\n        if (isBrowser()) {\n            if (this.options.appType === 'singlePage') {\n                this.setupSPATracking();\n            }\n            else {\n                this.setupMPATracking();\n            }\n            this.trackerActive = true;\n        }\n    }\n    cleanup() {\n        // No-op if document listener is not active\n        if (!this.trackerActive) {\n            return;\n        }\n        // Clean up SPA page view listeners\n        if (this.spaTrackingActive) {\n            window.history.pushState = this.originalPushState;\n            window.history.replaceState = this.originalReplaceState;\n            this.pushStateProxy?.revoke();\n            this.replaceStateProxy?.revoke();\n            window.removeEventListener('popstate', this.handleLocationChange);\n            this.spaTrackingActive = false;\n        }\n    }\n    setupSPATracking() {\n        if (!this.spaTrackingActive) {\n            // Configure proxies on History APIs\n            this.pushStateProxy = Proxy.revocable(window.history.pushState, {\n                apply: (target, thisArg, args) => {\n                    target.apply(thisArg, args);\n                    this.handleLocationChange();\n                },\n            });\n            this.replaceStateProxy = Proxy.revocable(window.history.replaceState, {\n                apply: (target, thisArg, args) => {\n                    target.apply(thisArg, args);\n                    this.handleLocationChange();\n                },\n            });\n            this.originalPushState = window.history.pushState;\n            this.originalReplaceState = window.history.replaceState;\n            window.history.pushState = this.pushStateProxy.proxy;\n            window.history.replaceState = this.replaceStateProxy.proxy;\n            window.addEventListener('popstate', this.handleLocationChange);\n            sessionStorage.removeItem(PREV_URL_STORAGE_KEY);\n            this.spaTrackingActive = true;\n        }\n    }\n    setupMPATracking() {\n        this.handleLocationChange();\n    }\n    handleLocationChange() {\n        const currentUrl = this.options.urlProvider();\n        const eventName = this.options.eventName || DEFAULT_EVENT_NAME;\n        if (this.urlHasChanged()) {\n            sessionStorage.setItem(PREV_URL_STORAGE_KEY, currentUrl);\n            // Assemble attribute list\n            const attributes = Object.assign({\n                url: currentUrl,\n            }, this.options.attributes);\n            logger.debug('Recording automatically tracked page view event', {\n                eventName,\n                attributes,\n            });\n            this.eventRecorder(eventName, attributes);\n        }\n    }\n    urlHasChanged() {\n        const prevUrl = sessionStorage.getItem(PREV_URL_STORAGE_KEY);\n        const currUrl = this.options.urlProvider();\n        return currUrl !== prevUrl;\n    }\n}\n"],"names":[],"mappings":"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"}