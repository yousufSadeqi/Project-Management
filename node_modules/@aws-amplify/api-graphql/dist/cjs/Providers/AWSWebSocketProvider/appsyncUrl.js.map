{"version":3,"file":"appsyncUrl.js","sources":["../../../../src/Providers/AWSWebSocketProvider/appsyncUrl.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.additionalHeadersFromOptions = exports.realtimeUrlWithQueryString = exports.queryParamsFromCustomHeaders = exports.getRealtimeEndpointUrl = exports.isCustomDomain = void 0;\nconst utils_1 = require(\"@aws-amplify/core/internals/utils\");\nconst protocol = 'wss://';\nconst standardDomainPattern = /^https:\\/\\/\\w{26}\\.appsync-api\\.\\w{2}(?:(?:-\\w{2,})+)-\\d\\.amazonaws.com(?:\\.cn)?\\/graphql$/i;\nconst eventDomainPattern = /^https:\\/\\/\\w{26}\\.\\w+-api\\.\\w{2}(?:(?:-\\w{2,})+)-\\d\\.amazonaws.com(?:\\.cn)?\\/event$/i;\nconst customDomainPath = '/realtime';\nconst isCustomDomain = (url) => {\n    return url.match(standardDomainPattern) === null;\n};\nexports.isCustomDomain = isCustomDomain;\nconst isEventDomain = (url) => url.match(eventDomainPattern) !== null;\nconst getRealtimeEndpointUrl = (appSyncGraphqlEndpoint) => {\n    let realtimeEndpoint = appSyncGraphqlEndpoint ?? '';\n    if (isEventDomain(realtimeEndpoint)) {\n        realtimeEndpoint = realtimeEndpoint\n            .concat(customDomainPath)\n            .replace('ddpg-api', 'grt-gamma')\n            .replace('appsync-api', 'appsync-realtime-api');\n    }\n    else if ((0, exports.isCustomDomain)(realtimeEndpoint)) {\n        realtimeEndpoint = realtimeEndpoint.concat(customDomainPath);\n    }\n    else {\n        realtimeEndpoint = realtimeEndpoint\n            .replace('appsync-api', 'appsync-realtime-api')\n            .replace('gogi-beta', 'grt-beta')\n            .replace('ddpg-api', 'grt-gamma');\n    }\n    realtimeEndpoint = realtimeEndpoint\n        .replace('https://', protocol)\n        .replace('http://', protocol);\n    return new utils_1.AmplifyUrl(realtimeEndpoint);\n};\nexports.getRealtimeEndpointUrl = getRealtimeEndpointUrl;\n/**\n * Strips out `Authorization` header if present\n */\nconst extractNonAuthHeaders = (headers) => {\n    if (!headers) {\n        return {};\n    }\n    if ('Authorization' in headers) {\n        const { Authorization: _, ...nonAuthHeaders } = headers;\n        return nonAuthHeaders;\n    }\n    return headers;\n};\n/**\n *\n * @param headers - http headers\n * @returns uri-encoded query parameters derived from custom headers\n */\nconst queryParamsFromCustomHeaders = (headers) => {\n    const nonAuthHeaders = extractNonAuthHeaders(headers);\n    const params = new utils_1.AmplifyUrlSearchParams();\n    Object.entries(nonAuthHeaders).forEach(([k, v]) => {\n        params.append(k, v);\n    });\n    return params;\n};\nexports.queryParamsFromCustomHeaders = queryParamsFromCustomHeaders;\n/**\n * Normalizes AppSync realtime endpoint URL\n *\n * @param appSyncGraphqlEndpoint - AppSync endpointUri from config\n * @param urlParams - URLSearchParams\n * @returns fully resolved string realtime endpoint URL\n */\nconst realtimeUrlWithQueryString = (appSyncGraphqlEndpoint, urlParams) => {\n    const realtimeEndpointUrl = (0, exports.getRealtimeEndpointUrl)(appSyncGraphqlEndpoint);\n    // preserves any query params a customer might manually set in the configuration\n    const existingParams = new utils_1.AmplifyUrlSearchParams(realtimeEndpointUrl.search);\n    for (const [k, v] of urlParams.entries()) {\n        existingParams.append(k, v);\n    }\n    realtimeEndpointUrl.search = existingParams.toString();\n    return realtimeEndpointUrl.toString();\n};\nexports.realtimeUrlWithQueryString = realtimeUrlWithQueryString;\n// TODO: move to separate file?\nconst additionalHeadersFromOptions = async (options) => {\n    const { appSyncGraphqlEndpoint, query, libraryConfigHeaders = () => ({}), additionalHeaders = {}, authToken, } = options;\n    let additionalCustomHeaders = {};\n    const _libraryConfigHeaders = await libraryConfigHeaders();\n    if (typeof additionalHeaders === 'function') {\n        const requestOptions = {\n            url: appSyncGraphqlEndpoint || '',\n            queryString: query || '',\n        };\n        additionalCustomHeaders = await additionalHeaders(requestOptions);\n    }\n    else {\n        additionalCustomHeaders = additionalHeaders;\n    }\n    // if an authorization header is set, have the explicit, operation-level authToken take precedence\n    if (authToken) {\n        additionalCustomHeaders = {\n            ...additionalCustomHeaders,\n            Authorization: authToken,\n        };\n    }\n    return {\n        additionalCustomHeaders,\n        libraryConfigHeaders: _libraryConfigHeaders,\n    };\n};\nexports.additionalHeadersFromOptions = additionalHeadersFromOptions;\n"],"names":[],"mappings":"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"}