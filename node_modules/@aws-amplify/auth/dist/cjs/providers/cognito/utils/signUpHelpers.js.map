{"version":3,"file":"signUpHelpers.js","sources":["../../../../../src/providers/cognito/utils/signUpHelpers.ts"],"sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.autoSignInUserConfirmed = exports.autoSignInWhenUserIsConfirmedWithLink = exports.handleCodeAutoSignIn = void 0;\nconst utils_1 = require(\"@aws-amplify/core/internals/utils\");\nconst signIn_1 = require(\"../apis/signIn\");\nconst AuthError_1 = require(\"../../../errors/AuthError\");\nconst autoSignIn_1 = require(\"../apis/autoSignIn\");\nconst constants_1 = require(\"../../../errors/constants\");\nconst signInWithUserAuth_1 = require(\"../apis/signInWithUserAuth\");\nconst MAX_AUTOSIGNIN_POLLING_MS = 3 * 60 * 1000;\nfunction handleCodeAutoSignIn(signInInput) {\n    const stopHubListener = utils_1.HubInternal.listen('auth-internal', async ({ payload }) => {\n        switch (payload.event) {\n            case 'confirmSignUp': {\n                const response = payload.data;\n                if (response?.isSignUpComplete) {\n                    utils_1.HubInternal.dispatch('auth-internal', {\n                        event: 'autoSignIn',\n                    });\n                    (0, autoSignIn_1.setAutoSignIn)(autoSignInWithCode(signInInput));\n                    stopHubListener();\n                }\n            }\n        }\n    });\n    // This will stop the listener if confirmSignUp is not resolved.\n    const timeOutId = setTimeout(() => {\n        stopHubListener();\n        clearTimeout(timeOutId);\n        (0, autoSignIn_1.resetAutoSignIn)();\n    }, MAX_AUTOSIGNIN_POLLING_MS);\n}\nexports.handleCodeAutoSignIn = handleCodeAutoSignIn;\nfunction debounce(fun, delay) {\n    let timer;\n    return (args) => {\n        if (!timer) {\n            fun(...args);\n        }\n        clearTimeout(timer);\n        timer = setTimeout(() => {\n            timer = undefined;\n        }, delay);\n    };\n}\nfunction handleAutoSignInWithLink(signInInput, resolve, reject) {\n    const start = Date.now();\n    const autoSignInPollingIntervalId = setInterval(async () => {\n        const elapsedTime = Date.now() - start;\n        const maxTime = MAX_AUTOSIGNIN_POLLING_MS;\n        if (elapsedTime > maxTime) {\n            clearInterval(autoSignInPollingIntervalId);\n            reject(new AuthError_1.AuthError({\n                name: constants_1.AUTO_SIGN_IN_EXCEPTION,\n                message: 'The account was not confirmed on time.',\n                recoverySuggestion: 'Try to verify your account by clicking the link sent your email or phone and then login manually.',\n            }));\n            (0, autoSignIn_1.resetAutoSignIn)();\n        }\n        else {\n            try {\n                const signInOutput = await (0, signIn_1.signIn)(signInInput);\n                if (signInOutput.nextStep.signInStep !== 'CONFIRM_SIGN_UP') {\n                    resolve(signInOutput);\n                    clearInterval(autoSignInPollingIntervalId);\n                    (0, autoSignIn_1.resetAutoSignIn)();\n                }\n            }\n            catch (error) {\n                clearInterval(autoSignInPollingIntervalId);\n                reject(error);\n                (0, autoSignIn_1.resetAutoSignIn)();\n            }\n        }\n    }, 5000);\n}\nconst debouncedAutoSignInWithLink = debounce(handleAutoSignInWithLink, 300);\nconst debouncedAutoSignWithCodeOrUserConfirmed = debounce(handleAutoSignInWithCodeOrUserConfirmed, 300);\nfunction autoSignInWhenUserIsConfirmedWithLink(signInInput) {\n    return async () => {\n        return new Promise((resolve, reject) => {\n            debouncedAutoSignInWithLink([signInInput, resolve, reject]);\n        });\n    };\n}\nexports.autoSignInWhenUserIsConfirmedWithLink = autoSignInWhenUserIsConfirmedWithLink;\nasync function handleAutoSignInWithCodeOrUserConfirmed(signInInput, resolve, reject) {\n    try {\n        const output = signInInput?.options?.authFlowType === 'USER_AUTH'\n            ? await (0, signInWithUserAuth_1.signInWithUserAuth)(signInInput)\n            : await (0, signIn_1.signIn)(signInInput);\n        resolve(output);\n        (0, autoSignIn_1.resetAutoSignIn)();\n    }\n    catch (error) {\n        reject(error);\n        (0, autoSignIn_1.resetAutoSignIn)();\n    }\n}\nfunction autoSignInWithCode(signInInput) {\n    return async () => {\n        return new Promise((resolve, reject) => {\n            debouncedAutoSignWithCodeOrUserConfirmed([signInInput, resolve, reject]);\n        });\n    };\n}\nexports.autoSignInUserConfirmed = autoSignInWithCode;\n"],"names":[],"mappings":"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"}